<html>
<head>
<script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.min.js"></script>
<script>THREEx.ArToolkitContext.baseURL = 'https://jeromeetienne.github.io/AR.js/three.js/'</script>
<script>
AFRAME.registerComponent('transparent-texture', {
	schema: {
		// Add properties.
	},
	
	init: function () {
		this.applyToMesh();
		this.el.addEventListener('model-loaded', () => this.applyToMesh());
	},
	
	applyToMesh: function() {
		const mesh = this.el.getObject3D('mesh');
		if (mesh) {
			
			mesh.traverse( function( child ) 
			{
				if ( child.isMesh )
				{
					//console.log('child mesh', child);
					child.material.transparent = true;
				/*	child.material.side = THREE.BackSide;
					child.material.depthTest = true;
					child.material.depthWrite = true;
				*/	
					child.material.needsUpdate = true;
					child.material.alphaTest = 0.5;
				}
			})
			
		//	console.log(mesh.material);
		//	mesh.material.transparent = true;
		}
	},
	
	update: function () {
		// Update `this.material`.
	}
});

var move_interval = null;

window.onload = function(){
	
	if(move_interval) clearInterval(move_interval);
	
	var camera = document.getElementById('camera');
	var camera_animation = document.getElementById('camera_animation');
	
	
	move_interval = setInterval(function(){
		var p = camera.getAttribute('position');
		console.log('camera position', p);
		p.x += (Math.random()-0.5)*10;
		p.z += (Math.random()-0.5)*10;
		var new_p = `${p.x} 0 ${p.z}`;
		console.log('new camera position', new_p);
		//camera.setAttribute('position', p);
		camera_animation.removeAttribute('to');
		camera_animation.setAttribute('to', new_p);
		camera_animation.emit('move');
	}, 3000);
	
	
	camera.addEventListener('componentchanged', function (evt) {
		console.log('camera changed', evt);
		if (evt.detail.name === 'position') {
			console.log('Camera position went from', evt.detail.oldData, 'to', evt.detail.newData);
			//var altitude = (this.el.getAttribute('position').z);
		}
		if (evt.detail.name === 'rotation') {
			console.log('Camera rotation went from', evt.detail.oldData, 'to', evt.detail.newData);
		}
	});
	
}

</script>
</head>
<body style='margin : 0px; overflow: hidden;'>
	<a-scene embedded artoolkit='sourceType: webcam;'>
		
		<!--
		<a-box position='0 0 0.5' material='opacity: 0.5;'></a-box>
		<a-marker-camera preset='hiro'></a-marker-camera>
		-->
		
		<a-assets>
			<a-asset-item id="fence" src="fence11.dae"></a-asset-item>
		</a-assets>
		
		<a-entity collada-model="#fence" transparent-texture></a-entity>
		
		<!--
		<a-entity position="0 0 5">
			<a-camera></a-camera>
		</a-entity>
		-->
		
		
		<a-entity camera="userHeight: 1.6" id="camera" position="5 0 5">
			<a-animation id="camera_animation" attribute="position"
				dur="100"
				easing="linear"
				begin="move"
				to="5 0 5"
				></a-animation>
		</a-entity>
		
		<!--
		<a-camera id="camera" position="5 0 5" user-height="1.6"></a-camera>
		-->
	</a-scene>
</body>
</html>
