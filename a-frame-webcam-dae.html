<html>
<head>
<script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.min.js"></script>
<script>THREEx.ArToolkitContext.baseURL = 'https://jeromeetienne.github.io/AR.js/three.js/'</script>
<script>
AFRAME.registerComponent('transparent-texture', {
	
	init: function () {
		this.applyToMesh();
		this.el.addEventListener('model-loaded', () => this.applyToMesh());
	},
	
	applyToMesh: function() {
		const mesh = this.el.getObject3D('mesh');
		if (mesh)
			mesh.traverse( function( child ) {
				if ( child.isMesh )
				{
					child.material.transparent = true;
					child.material.alphaTest = 0.5;
				}
			});
	}
	
});


function geo_watch(success, error) {
	
	if(!error)
		error = function(err) { console.warn(`ERROR(${err.code}): ${err.message}`); };
	
	if (!("geolocation" in navigator)){
		error({code: 0, message: 'Geolocation is not supported by your browser'});
		return;
	}
	
	return navigator.geolocation.watchPosition(success, error, {enableHighAccuracy: true, maximumAge: 0, timeout: 27000});
}

function meters(src, dest){
	var dlon = THREE.Math.degToRad(dest.longitude - src.longitude);
	var dlat = THREE.Math.degToRad(dest.latitude - src.latitude);
	var a = (Math.sin(dlat / 2) * Math.sin(dlat / 2)) + Math.cos(Math.radians(src.latitude)) * Math.cos(Math.radians(dest.latitude)) * (Math.sin(dlon / 2) * Math.sin(dlon / 2));
	var angle = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
	return angle * 6378160;
}


var zero_crd = null;
var geo_watch_id = null;

window.onload = function(){
	
	var camera = document.getElementById('camera');
	var nogps = document.getElementById('nogps');
	
	
	geo_watch_id = geo_watch(function(position){
		var crd = position.coords;
		
		console.log('Your current position is:');
		console.log(`Latitude : ${crd.latitude}`);
		console.log(`Longitude: ${crd.longitude}`);
		console.log(`More or less ${crd.accuracy} meters.`);
		
		if(crd.accuracy < 100){
			
			nogps.setAttribute('visible', false);
			
			if(!zero_crd) zero_crd = crd;
			
			// lat = z
			// lon = x
			
			var p = camera.getAttribute('position');
			console.log('camera position', p);
			p.x = meters(zero_crd, {longitude: crd.longitude, latitude: zero_crd.latitude}) * (crd.longitude > zero_crd.longitude ? 1 : -1);
			p.z = meters(zero_crd, {longitude: zero_crd.longitude, latitude: crd.latitude}) * (crd.latitude > zero_crd.latitude ? 1 : -1);
			console.log('new camera position', p);
			camera.setAttribute('position', p);
			
		}else{
			
			nogps.setAttribute('visible', true);
			
		}
		
	});
	
	/*
	move_interval = setInterval(function(){
		var p = camera.getAttribute('position');
		console.log('camera position', p);
		p.x += (Math.random()-0.5)*10;
		p.z += (Math.random()-0.5)*10;
		console.log('new camera position', p);
		camera.setAttribute('position', p);
	}, 3000);
	*/
}

</script>
</head>
<body style='margin: 0px; overflow: hidden;'>
	<a-scene embedded artoolkit='sourceType: webcam;'>
		
		<a-entity id="nogps" bmfont-text="text: WHERE IS GPS?; color: #333" position="0 2 0"></a-entity>
		
		<a-camera id="camera" user-height="1.6"></a-camera>
		
		<a-assets>
			<a-asset-item id="fence_asset" src="fence11.dae"></a-asset-item>
		</a-assets>
		
		<a-entity id="fence" collada-model="#fence_asset" transparent-texture></a-entity>
		
	</a-scene>
</body>
</html>
