<html>
<head>
<script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.min.js"></script>
<script>THREEx.ArToolkitContext.baseURL = 'https://jeromeetienne.github.io/AR.js/three.js/'</script>
<script>
AFRAME.registerComponent('transparent-texture', {
	
	init: function () {
		this.applyToMesh();
		this.el.addEventListener('model-loaded', () => this.applyToMesh());
	},
	
	applyToMesh: function() {
		const mesh = this.el.getObject3D('mesh');
		if (mesh)
			mesh.traverse( function( child ) {
				if ( child.isMesh )
				{
					child.material.transparent = true;
					child.material.alphaTest = 0.5;
				}
			});
	}
	
});


function geo_watch(success, error) {
	
	if(!error)
		error = function(err) { console.warn(`ERROR(${err.code}): ${err.message}`); };
	
	if (!("geolocation" in navigator)){
		error({code: 0, message: 'Geolocation is not supported by your browser'});
		return;
	}
	
	return navigator.geolocation.watchPosition(success, error, {enableHighAccuracy: true, maximumAge: 0, timeout: 27000});
}

Math.radians = THREE.Math.degToRad;

function meters(src, dest){
	var dlon = Math.radians(dest.longitude - src.longitude);
	var dlat = Math.radians(dest.latitude - src.latitude);
	var a = (Math.sin(dlat / 2) * Math.sin(dlat / 2)) + Math.cos(Math.radians(src.latitude)) * Math.cos(Math.radians(dest.latitude)) * (Math.sin(dlon / 2) * Math.sin(dlon / 2));
	var angle = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
	return angle * 6378160;
}




var zero_crd = null;
var geo_watch_id = null;

function set_camera_by_crd(camera, crd, accuracy){
	
	console.log('new gps position', crd);
	
	crd_longitude.innerText = crd.longitude;
	crd_latitude.innerText = crd.latitude;
	
	if(crd.accuracy < accuracy){
		
		if(!zero_crd){
			zero_crd = crd;
			console.log('zero coords', zero_crd);
			
			zero_crd_longitude.innerText = zero_crd.longitude;
			zero_crd_latitude.innerText = zero_crd.latitude;
		}
		
		
		// lat = z
		// lon = x
		
		var p = camera.getAttribute('position');
		
		console.log('camera position', p);
		
		p.x = meters(zero_crd, {longitude: crd.longitude, latitude: zero_crd.latitude}) * (crd.longitude > zero_crd.longitude ? -1 : 1);
		p.z = meters(zero_crd, {longitude: zero_crd.longitude, latitude: crd.latitude}) * (crd.latitude > zero_crd.latitude ? -1 : 1);
		
		camera_p_x.innerText = p.x;
		camera_p_z.innerText = p.z;
		
		console.log('new camera position', p);
		
		camera.setAttribute('position', p);
		
	}else{
		
		
		
	}
	
}




function compassHeading(alpha, beta, gamma) {
	
	// Convert degrees to radians
	var alphaRad = alpha * (Math.PI / 180);
	var betaRad = beta * (Math.PI / 180);
	var gammaRad = gamma * (Math.PI / 180);
	
	// Calculate equation components
	var cA = Math.cos(alphaRad);
	var sA = Math.sin(alphaRad);
	var cB = Math.cos(betaRad);
	var sB = Math.sin(betaRad);
	var cG = Math.cos(gammaRad);
	var sG = Math.sin(gammaRad);
	
	// Calculate A, B, C rotation components
	var rA = - cA * sG - sA * sB * cG;
	var rB = - sA * sG + cA * sB * cG;
	var rC = - cB * cG;
	
	// Calculate compass heading
	var compassHeading = Math.atan(rA / rB);
	
	// Convert from half unit circle to whole unit circle
	if(rB < 0) {
		compassHeading += Math.PI;
	}else if(rA < 0) {
		compassHeading += 2 * Math.PI;
	}
	
	// Convert radians to degrees
	compassHeading *= 180 / Math.PI;
	
	return compassHeading;
}

set_camera_by_angle.last_timestamp = 0;

function set_camera_by_angle(camera, angle, time_limit){
	
	if(typeof(time_limit) == 'undefined') time_limit = 1000;
	
	var timestamp = Date.now();
	
	if((set_camera_by_angle.last_timestamp + time_limit) > timestamp){
		return;
	}
	
	set_camera_by_angle.last_timestamp = timestamp;
	
	console.log('new camera angle', angle);
	
	orientation_angle.innerText = angle;
	
	var r = camera.getAttribute('rotation');
	
	console.log('camera rotation', r);
	
	r.y = angle;
	
	console.log('new camera rotation', r);
	
	camera.setAttribute('rotation', r);
	
}

window.onload = function(){
	
	var camera = document.getElementById('camera');
	
	/* gps camera positioning */
	console.log('gps camera positioning');
	geo_watch_id = geo_watch(function(position){
		
		var crd = position.coords;
		
		set_camera_by_crd(camera, crd, 100);
		
	});
	/* /gps camera positioning */
	
	/* fake camera positioning 
	console.log('fake camera positioning');
	zero_crd = {longitude: 55.1409698, latitude: 37.4602963, accuracy: 10};
	var crd = JSON.parse(JSON.stringify(zero_crd));
	
	move_interval = setInterval(function(){
		
		crd.longitude += (Math.random()-0.5)/10000;
		crd.latitude += (Math.random()-0.5)/10000;
		
		set_camera_by_crd(camera, crd, 100);
		
	}, 3000);*/
	/* /fake camera positioning */
	
	/* magnet sensor camera positioning */
	window.addEventListener('deviceorientation', function(evt) {
		
		var heading = null;
		
		if(typeof(evt.webkitCompassHeading) != 'undefined'
		&& evt.webkitCompassAccuracy < 50){
			heading = evt.webkitCompassHeading;
		}else if(evt.absolute === true
		&& evt.alpha !== null
		&& evt.beta !== null
		&& evt.gamma !== null) {
			heading = compassHeading(evt.alpha, evt.beta, evt.gamma);
		}
		
		if(heading && heading > 0)
			set_camera_by_angle(camera, heading, 1000);
		
	}, false);
	/* /magnet sensor camera positioning */
	
}








</script>
</head>
<body style='margin: 0px; overflow: hidden;'>
	
	<div style='position: fixed; top: 10px; width:100%; text-align: center; z-index: 1;'>
		<div>
			coords: <span id="crd_longitude"></span>, <span id="crd_latitude"></span>
				(zero coords: <span id="zero_crd_longitude"></span>, <span id="zero_crd_latitude"></span>)
		</div>
		<div>
			camera coords: <span id="camera_p_x"></span>, <span id="camera_p_z"></span>
		</div>
		<div>
			orientation_angle: <span id="orientation_angle"></span>
		</div>
	</div>
	
	<a-scene embedded artoolkit='sourceType: webcam;'>
		
		<a-camera id="camera" user-height="1.6"></a-camera>
		
		<a-assets>
			<a-asset-item id="fence_asset" src="fence11.dae"></a-asset-item>
		</a-assets>
		
		<a-entity id="fence" collada-model="#fence_asset" transparent-texture></a-entity>
		
	</a-scene>
</body>
</html>
